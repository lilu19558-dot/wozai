<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>ç»“æœ - æˆ‘åœ¨èƒŒå•è¯ï¼ˆå…­å•å…ƒï¼‰</title>
<style>
  body {
    margin:0;
    font-family:-apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "æ€æºé»‘ä½“", "Noto Sans SC", sans-serif;
    background:linear-gradient(135deg,#fdfdfd,#f4f4f7);
    display:flex; flex-direction:column; align-items:center; justify-content:center;
    min-height:100vh; color:#1c1c1e; text-align:center;
  }
  header {
    position:fixed; top:0; width:100%; height:80px; background:#ffffff;
    display:flex; align-items:center; justify-content:center; box-shadow:0 2px 10px rgba(0,0,0,0.1);
    z-index:1000; cursor:pointer;
  }
  header h1 { margin:0; font-size:28px; letter-spacing:1px; text-align:center; }
  header h1 .brand { font-weight:700; color:#007bff; }
  header h1 .subtitle { font-weight:400; color:#555555; font-size:22px; margin-left:8px; }

  #congrats {
    font-size:8vw; margin-top:100px; font-weight:900; text-transform:uppercase;
    background: linear-gradient(270deg, #ff4d4d, #ffcc00, #33cc33, #3399ff, #cc33ff, #ff66cc, #00e6e6);
    background-size: 1000% 1000%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    animation: rainbowGlow 6s linear infinite, glowPulse 2s ease-in-out infinite alternate;
  }
  @keyframes rainbowGlow {
    0% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
    100% { background-position: 0% 50%; }
  }
  @keyframes glowPulse {
    0% { text-shadow: 0 0 8px rgba(255,255,255,0.6), 0 0 16px rgba(255,0,255,0.6); }
    100% { text-shadow: 0 0 20px rgba(255,255,255,1), 0 0 40px rgba(0,255,255,1); }
  }

  p { font-size:4.5vw; margin:8px 0; }
  #streak { margin-top:12px; font-size:20px; font-weight:600; color:#ff8000; text-align:center; }
  #elapsed { margin-top:6px; font-size:26px; font-weight:700; color:#007bff; text-align:center; }
  #localTime { font-size:3.8vw; color:#333; }
  #typingStats { font-size:4.5vw; margin-top:10px; color:#444; }

  .buttons { margin-top:30px; display:flex; gap:14px; flex-wrap:wrap; justify-content:center; }
  button {
    padding:3vw 6vw; font-size:4.5vw; border-radius:12px;
    border:none; background:#007aff; color:white; cursor:pointer; transition:0.3s;
  }
  button:hover { background:#0059c9; }

  @media (min-width:768px) {
    #congrats { font-size:56px; }
    p { font-size:22px; }
    #streak { font-size:20px; }
    #elapsed { font-size:24px; }
    #localTime { font-size:18px; }
    #typingStats { font-size:20px; }
    button { font-size:18px; padding:12px 24px; }
  }

  /* é¢„è§ˆå±‚ */
  #previewContainer {
    display:none;
    position:fixed;
    top:0; left:0; width:100%; height:100%;
    background:rgba(0,0,0,0.7);
    justify-content:center;
    align-items:center;
    z-index:2000;
    flex-direction:column;
  }
  #previewContainer img {
    max-width:90%;
    max-height:80%;
    border-radius:12px;
    box-shadow:0 8px 30px rgba(0,0,0,0.5);
  }
  #closePreview {
    margin-top:20px;
    padding:10px 20px;
    background:#ff4d4d;
    color:#fff;
    border:none;
    border-radius:8px;
    cursor:pointer;
    font-size:16px;
  }
</style>
</head>
<body>

<header onclick="goHome()">
  <h1>
    <span class="brand">æˆ‘åœ¨</span>
    <span class="subtitle">èƒŒå•è¯ (wozai)</span>
  </h1>
</header>

<h1 id="congrats"></h1>
<p id="elapsed"></p> <!-- ç”¨æ—¶æ˜¾ç¤º -->
<p id="info"></p>
<p id="streak"></p>
<p id="localTime"></p>
<p id="typingStats"></p>

<div class="buttons">
  <button onclick="nextUnit()">ä¸‹ä¸€å•å…ƒ</button>
  <button onclick="restartUnit()">å†æ¥ä¸€æ¬¡</button>
  <button onclick="shareWithLink()">ğŸŒ åˆ†äº«æˆç»©</button>
  <button onclick="shareImage()">ğŸ–¼ ç”Ÿæˆæˆç»©å•å›¾ç‰‡</button>
</div>

<!-- é¢„è§ˆå®¹å™¨ -->
<div id="previewContainer">
  <img id="previewImage" />
  <button id="closePreview" onclick="document.getElementById('previewContainer').style.display='none'">å…³é—­é¢„è§ˆ</button>
</div>

<!-- éšè—çš„ç”Ÿæˆå¡ç‰‡ -->
<div id="hiddenCard" style="position:absolute;left:-9999px;top:-9999px;"></div>

<!-- åº“ -->
<script src="https://cdn.jsdelivr.net/npm/canvas-confetti@1.9.2/dist/confetti.browser.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/html2canvas@1.4.1/dist/html2canvas.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/qrcode/build/qrcode.min.js"></script>

<script>
(function(){
  const raw = localStorage.getItem("typingResult");
  if(!raw){
    window.location.href="Jijiao-Grade7-Book1-Unit6.html";
    return;
  }
  const result = JSON.parse(raw);
  localStorage.removeItem("typingResult");

  const congratsWords = ["CONGRATULATIONS!","WELL DONE!","AMAZING!","FANTASTIC!","SUPERB!"];
  const chosen = congratsWords[Math.floor(Math.random() * congratsWords.length)];

  document.getElementById("congrats").textContent = chosen;
  document.getElementById("info").textContent = `${result.version} | ${result.grade} | ${result.unit}`;
  document.getElementById("streak").textContent = `æœ€å¤§è¿èƒœ: ${result.maxStreak ?? 0}`;

  // æ ¼å¼åŒ–æ¯«ç§’ä¸º åˆ†ç§’æ¯«ç§’
  function formatTime(ms){
    const minutes=Math.floor(ms/60000);
    const seconds=Math.floor((ms%60000)/1000);
    const milliseconds=ms%1000;
    return `${minutes}åˆ†${seconds}ç§’${milliseconds}æ¯«ç§’`;
  }
  document.getElementById("elapsed").textContent = `ç”¨æ—¶: ${formatTime(result.time||0)}`;

  const now = new Date();
  const localTime = `æäº¤æ—¶é—´: ${now.toLocaleString("zh-CN",{hour12:false})}.${String(now.getMilliseconds()).padStart(3,"0")}`;
  document.getElementById("localTime").textContent = localTime;

  const totalWords = result.totalWords||0;
  const correct = result.correct||0;
  const wrong = result.wrong||0;
  const accuracy = totalWords ? Math.round(correct/totalWords*100) : 0;
  document.getElementById("typingStats").textContent =
    `å·²å®Œæˆ: ${totalWords} | æ­£ç¡®: ${correct} | é”™è¯¯: ${wrong} | æ­£ç¡®ç‡: ${accuracy}%`;

  // å½©å¸¦åŠ¨ç”»
  setTimeout(()=>{confetti({
    particleCount:250, spread:180, origin:{x:0.5,y:0.3},
    colors:["#ff4d4d","#ffcc00","#33cc33","#3399ff","#cc33ff","#ff66cc","#00e6e6"],
    scalar:1.4, ticks:240
  });},200);

  // åˆ†äº«ï¼šå¸¦ç½‘ç«™é“¾æ¥
  window.shareWithLink = function(){
    const text = `æˆ‘åœ¨èƒŒå•è¯å®Œæˆäº† ${result.grade} ${result.unit}ï¼
æ­£ç¡®ç‡ ${accuracy}%ï¼
ç”¨æ—¶ ${formatTime(result.time||0)}
${localTime}
â€”â€”
ğŸŸ¢ æˆ³è¿™é‡Œç»§ç»­æŒ‘æˆ˜ â†’ ${location.href}`;
    if(navigator.share){
      navigator.share({title:"æˆ‘çš„æˆç»©", text:text});
    }else{
      navigator.clipboard.writeText(text);
      alert("å·²å¤åˆ¶æˆç»©ï¼Œå¯è‡ªè¡Œç²˜è´´åˆ†äº«ï¼");
    }
  };

  // åˆ†äº«ï¼šç”Ÿæˆæˆç»©å•å›¾ç‰‡
  window.shareImage = function(){
    const hidden = document.getElementById("hiddenCard");
    hidden.innerHTML = ""; // æ¸…ç©º

    const card = document.createElement("div");
    card.style.width="600px";
    card.style.height="900px";
    card.style.background="linear-gradient(to bottom, #fff8e1, #ffe0b2)";
    card.style.display="flex";
    card.style.flexDirection="column";
    card.style.alignItems="center";
    card.style.justifyContent="flex-start";
    card.style.fontFamily="sans-serif";
    card.style.border="10px solid gold";
    card.style.borderRadius="20px";
    card.style.padding="30px";
    card.style.textAlign="center";

    const title = document.createElement("h2");
    title.innerHTML = `<span style="color:#007bff;font-weight:700;">æˆ‘åœ¨</span>èƒŒå•è¯`;
    title.style.fontSize="48px"; 
    title.style.marginBottom="20px";
    card.appendChild(title);

    // ç”¨æ—¶ï¼ˆæ¸…æ™°çªå‡ºï¼‰
    const timeEl = document.createElement("p");
    timeEl.textContent = "ç”¨æ—¶: " + formatTime(result.time||0);
    timeEl.style.fontSize="40px";
    timeEl.style.fontWeight="900";
    timeEl.style.color="#007bff";
    timeEl.style.margin="20px 0";
    card.appendChild(timeEl);

    const info = document.createElement("div");
    info.innerHTML = `
      <p style="font-size:36px;font-weight:700;color:#222;margin:12px 0;">${result.grade} ${result.unit}</p>
      <p style="font-size:42px;font-weight:900;color:#d2691e;margin:18px 0;">æ­£ç¡®ç‡ï¼š${accuracy}%</p>
      <p style="font-size:30px;color:#444;margin:12px 0;">å®Œæˆï¼š${totalWords} | æ­£ç¡®ï¼š${correct} | é”™è¯¯ï¼š${wrong}</p>
      <p style="font-size:22px;color:#555;margin-top:20px;">${localTime}</p>
    `;
    card.appendChild(info);

    const footer = document.createElement("div");
    footer.innerText="ğŸ“± æ‰«ç åŠ å…¥æŒ‘æˆ˜";
    footer.style.fontSize="24px";
    footer.style.marginTop="40px";
    footer.style.color="#333";
    footer.style.fontWeight="600";
    card.appendChild(footer);

    const qrCanvas = document.createElement("canvas");
    card.appendChild(qrCanvas);

    hidden.appendChild(card);

    QRCode.toCanvas(qrCanvas, location.href, {width:160, margin:1}, function(){
      html2canvas(card).then(canvas=>{
        document.getElementById("previewImage").src = canvas.toDataURL("image/png");
        document.getElementById("previewContainer").style.display="flex";
      });
    });
  };

  // è·³è½¬æŒ‰é’®
  window.nextUnit=function(){ window.location.href="Jijiao-Grade7-Book1-Unit7.html"; }
  window.restartUnit=function(){ window.location.href="Jijiao-Grade7-Book1-Unit6.html"; }
  window.goHome=function(){ window.location.href="index.html"; }
})();
</script>
</body>
</html>
